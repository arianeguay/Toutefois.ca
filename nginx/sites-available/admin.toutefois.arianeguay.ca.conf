# HTTP -> HTTPS
server {
    listen 80;
    server_name admin.toutefois.arianeguay.ca;
    return 301 https://$host$request_uri;
}

# HTTPS (PHP-FPM)
server {
    listen 443 ssl;
    http2 on;
    server_name admin.toutefois.arianeguay.ca;

    ssl_certificate         /etc/letsencrypt/live/toutefois.arianeguay.ca/fullchain.pem;
    ssl_certificate_key     /etc/letsencrypt/live/toutefois.arianeguay.ca/privkey.pem;
    ssl_trusted_certificate /etc/letsencrypt/live/toutefois.arianeguay.ca/chain.pem;

    root  /var/www/wordpress;
    index index.php index.html index.htm;

    client_max_body_size 64m;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # CORS only for the REST API (avoid touching wp-admin cookies)
    location ^~ /wp-json/ {
        # Preflight
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin      "$http_origin" always;
            add_header Vary                             Origin always;
            add_header Access-Control-Allow-Methods     "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers     "Authorization,Content-Type,X-WP-Nonce" always;
            add_header Access-Control-Allow-Credentials "true" always;
            add_header Content-Length 0;
            add_header Content-Type "text/plain; charset=utf-8";
            return 204;
        }
        add_header Access-Control-Allow-Origin      "$http_origin" always;
        add_header Vary                             Origin always;
        add_header Access-Control-Allow-Credentials "true" always;
        add_header Access-Control-Expose-Headers    "X-WP-Total, X-WP-TotalPages" always;

        try_files $uri $uri/ /index.php?$args;
    }

    # Normal front-controller for everything else (wp-admin, etc.)
    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    # ---- PHP-FPM ----
    location ~ \.php$ {
        include snippets/fastcgi-php.conf;

        # Pick ONE of the next two lines (socket OR TCP). Use the one that exists on your server.
        fastcgi_pass unix:/var/run/php/php8.3-fpm.sock;   # e.g. php8.3-fpm.sock
        # fastcgi_pass 127.0.0.1:9000;                    # if using TCP instead of a unix socket

        fastcgi_param HTTPS on;
        fastcgi_param HTTP_X_FORWARDED_PROTO https;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }

    location ~ /\.ht { deny all; }
}
