# HTTP -> HTTPS
server {
    listen 80;
    server_name admin.toutefois.arianeguay.ca;
    return 301 https://$host$request_uri;
}

# HTTPS (PHP-FPM 8.4)
server {
    listen 443 ssl;
    http2 on;
    server_name admin.toutefois.arianeguay.ca;

    # Adjust if your live dir name differs (drop -0001 unless it exists)
    ssl_certificate         /etc/letsencrypt/live/toutefois.arianeguay.ca/fullchain.pem;
    ssl_certificate_key     /etc/letsencrypt/live/toutefois.arianeguay.ca/privkey.pem;
    ssl_trusted_certificate /etc/letsencrypt/live/toutefois.arianeguay.ca/chain.pem;

    root  /var/www/wordpress;
    index index.php index.html index.htm;

    client_max_body_size 64m;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # --- Pretty REST route: /wp-json/... ---
    # CORS headers live at the location level (legal); OPTIONS just returns 204 (no headers inside 'if')
    location ^~ /wp-json/ {
        # CORS headers for all requests to /wp-json/
        add_header Access-Control-Allow-Origin      $cors_allow_origin always;
        add_header Vary                             Origin always;
        add_header Access-Control-Allow-Credentials "true" always;
        add_header Access-Control-Allow-Headers     "Content-Type, Authorization" always;
        add_header Access-Control-Allow-Methods     "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Expose-Headers    "X-WP-Total, X-WP-TotalPages" always;

        # Preflight (allowed 'if' that only returns)
        if ($is_options) { return 204; }

        try_files $uri $uri/ /index.php?$args;
    }

    # Normal front controller for everything else (wp-admin, etc.)
    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    # ---- PHP-FPM (8.4) ----
    location ~ \.php$ {
        include snippets/fastcgi-php.conf;

        # Use the socket that actually exists on your machine:
        fastcgi_pass unix:/run/php/php8.4-fpm.sock;
        # If your pool listens on TCP instead, comment the line above and use:
        # fastcgi_pass 127.0.0.1:9000;

        fastcgi_param HTTPS on;
        fastcgi_param HTTP_X_FORWARDED_PROTO https;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
    }

    # Deny access to dotfiles like .htaccess
    location ~ /\.ht { deny all; }
}
